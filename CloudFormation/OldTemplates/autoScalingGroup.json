{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Deploy an Autoscaled Group of Instances. Authored by Daniel Wright",
  "Parameters": {
    "ec2ImageParameter": {
      "Default": "ami-XXXXXXXX",
      "Type": "String"
    },
    "keyName": {
      "Default": "NT-Oregon",
      "Description": "Name of pem file to use when launching instances",
      "Type": "String"
    },
    "privateSubnet1": {
      "Description": "Availability Zone 1 Private Subnet",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "privateSubnet2": {
      "Description": "Availability Zone 2 Private Subnet",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "publicSubnet1": {
      "Description": "Availability Zone 1 Public Subnet",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "publicSubnet2": {
      "Description": "Availability Zone 2 Public Subnet",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "vpcId": {
      "Description": "Select a VPC-ID to use",
      "Type": "AWS::EC2::VPC::Id"
    }
  },
  "Resources": {
    "autoScalingGroup": {
      "Properties": {
        "LaunchConfigurationName": {
          "Ref": "launchConfiguration"
        },
        "LoadBalancerNames": [
          {
            "Ref": "elasticLoadBalancer"
          }
        ],
        "MaxSize": "4",
        "MetricsCollection": [
          {
            "Granularity": "1Minute",
            "Metrics": [
              "GroupMinSize",
              "GroupMaxSize"
            ]
          }
        ],
        "MinSize": "2",
        "VPCZoneIdentifier": [
          {
            "Ref": "privateSubnet1"
          },
          {
            "Ref": "privateSubnet2"
          }
        ]
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": "1",
          "MinInstancesInService": "1",
          "PauseTime": "PT12M5S"
        }
      }
    },
    "demoAppSecurityGroup": {
      "Properties": {
        "GroupDescription": "Demo App Allow Traffic",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "0",
            "IpProtocol": "tcp",
            "ToPort": "65535"
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "0",
            "IpProtocol": "tcp",
            "ToPort": "65535"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "Demo App Group"
          }
        ],
        "VpcId": {
          "Ref": "vpcId"
        }
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "elasticLoadBalancer": {
      "Properties": {
        "HealthCheck": {
          "HealthyThreshold": "3",
          "Interval": "30",
          "Target": "HTTP:8080/",
          "Timeout": "5",
          "UnhealthyThreshold": "5"
        },
        "Listeners": [
          {
            "InstancePort": "8080",
            "LoadBalancerPort": "80",
            "Protocol": "HTTP"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "demoAppSecurityGroup"
          }
        ],
        "Subnets": [
          {
            "Ref": "publicSubnet1"
          },
          {
            "Ref": "publicSubnet2"
          }
        ]
      },
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer"
    },
    "launchConfiguration": {
      "Properties": {
        "ImageId": {
          "Ref": "ec2ImageParameter"
        },
        "InstanceType": "t2.micro",
        "KeyName": {
          "Ref": "keyName"
        },
        "SecurityGroups": [
          {
            "Ref": "demoAppSecurityGroup"
          }
        ]
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    }
  },
	"Outputs": {
		"autoScalingGroup": {
			"Description": "AutoScaling Group Containing Instances",
			"Value": {
				"Ref": "autoScalingGroup"
			}
		},
		"demoAppSecurityGroup": {
			"Description": "Securtiy Group Allowing All Traffic",
			"Value": {
				"Ref": "demoAppSecurityGroup"
			}
		},
		"elasticLoadBalancer": {
			"Description": "ELB for AutoScaling Group",
			"Value": {
				"Ref": "elasticLoadBalancer"
			}
		},
		"launchConfiguration": {
			"Description": "Launch Config for AutoScaling Group",
			"Value": {
				"Ref": "launchConfiguration"
			}
		}
	}
}
