- name: setup the amazon region variables
  set_fact:
    regions:
      ap-southeast-2:
        zone: "{{ availability_zone }}"
        keypair: "{{ key_name }}"
        vpc_subnet_id: ""{{ vpc_subnet }}""
        group_id: "{{ security_group }}"
    volumes:
      ubuntu:
        - device_name: /dev/sda1
          device_type: gp2
          volume_size: 20
          delete_on_termination: true

- name: Search for the latest Ubuntu 14.04 AMI
  ec2_ami_find:
    region: "{{ region }}"
    name: "ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-*"
    owner: 099720109477
    sort: name
    sort_order: descending
    sort_end: 1
    no_result_action: fail
  register: ami_result
  when: ami_type == "ubuntu"

- name: Search for the latest Amazon Linux AMI
  ec2_ami_find:
    region: "{{ region }}"
    name: "amzn-ami-hvm-2015.09.2.x86_64-gp2"
    owner: 137112412989
    sort: name
    sort_order: descending
    sort_end: 1
    no_result_action: fail
  register: ami_result
  when: ami_type == "amazonlinux"

- name: Launch new instance
  ec2:
    region: "{{ region }}"
    keypair: "{{ regions[region].keypair }}"
    zone: "{{ regions[region].zone }}"
    vpc_subnet_id: "{{ regions[region].vpc_subnet_id }}"
    group_id: "{{ regions[region].group_id }}"
    image: "{{ ami_result.results[0].ami_id }}"
    instance_type: "{{ instance_type }}"
    instance_tags:
      Name: "{{ name }}"
    volumes: "{{ volumes[ami_type] }}"
    wait: yes
  register: ec2

- name: Add new instances to host group
  add_host:
    name: "{{ item.private_ip }}"
    groups: "{{ name }}"
    ec2_id: "{{ item.id }}"
  with_items: ec2.instances

- name: Wait for instance to boot
  wait_for:
    host: "{{ item.private_ip }}"
    port: 22
    delay: 30
    timeout: 300
    state: started
  with_items: ec2.instances
